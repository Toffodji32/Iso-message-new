{% extends 'base.html.twig' %}

{% block title %}Nouveau Contact{% endblock %}

{% block body %}
    <div class="container mt-5">
        <h2 class="mb-4">Ajouter un nouveau contact</h2>

        <div id="contact-form-container">
            {{ include('contact/_form.html.twig', {
                form: form,
                button_label: 'Créer',
                contact: contact
            }) }}
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const formContainer = document.getElementById('contact-form-container');

            function bindAjaxForm() {
                const form = document.getElementById('contact-form');

                if (!form) return;

                form.addEventListener('submit', function (e) {
                    e.preventDefault(); // Empêche le rechargement

                    const formData = new FormData(form);

                    fetch(form.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest' // important pour détecter AJAX côté serveur
                        }
                    })
                    .then(response => response.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const newForm = doc.querySelector('#contact-form');

                        if (newForm) {
                            formContainer.innerHTML = doc.getElementById('contact-form-container') 
                                ? doc.getElementById('contact-form-container').innerHTML
                                : newForm.outerHTML;
                            bindAjaxForm(); // Rebind après remplacement
                        } else {
                            // Succès : redirection ou message de succès
                            alert("Contact ajouté avec succès !");
                            location.reload();
                        }
                    })
                    .catch(error => {
                        console.error('Erreur AJAX :', error);
                    });
                });
            }

            bindAjaxForm(); // initial bind
        });
    </script>
{% endblock %}
