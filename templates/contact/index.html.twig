{% extends 'base.html.twig' %}

{% block title %}Mes Contacts{% endblock %}
{% block header_title %}Carnet d'adresses > Mes contacts{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .contacts-container { max-width: 1200px; margin: 0 auto; padding: 2rem 1rem; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .page-title { font-size: 1.8rem; font-weight: 600; color: #333; }
        .btn { padding: 0.6rem 1.2rem; border-radius: 6px; font-weight: 500; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-success { background-color: #10b981; color: white; }
        .btn-success:hover { background-color: #059669; }
        .filter-section { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem; }
        .filter-form { display: flex; flex-wrap: wrap; gap: 1.5rem; align-items: flex-end; }
        .form-group { flex: 1; display: flex; flex-direction: column; }
        .form-label { margin-bottom: 0.5rem; font-weight: 500; }
        .form-control, .form-select { padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 6px; }
        .contacts-table-container { background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; }
        .contacts-table { width: 100%; border-collapse: collapse; }
        .contacts-table th, .contacts-table td { padding: 1rem; border-bottom: 1px solid #f3f4f6; }
        .contacts-table thead { background-color: #f3f4f6; }
        .actions-cell .btn { margin-right: 0.3rem; }
        .badge { padding: 0.25rem 0.5rem; background-color: #e5e7eb; border-radius: 4px; font-size: 0.75rem; }
        .empty-state { text-align: center; padding: 2rem; color: #6b7280; }
        .empty-state i { font-size: 2.5rem; color: #d1d5db; margin-bottom: 1rem; }
        .contacts-stats { margin-bottom: 0.5rem; font-weight: 500; }
        @media (max-width: 768px) {
            .filter-form { flex-direction: column; }
            .page-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
        }
    </style>
{% endblock %}

{% block body %}
<div class="contacts-container">
    <div class="page-header">
        <h1 class="page-title">Mes Contacts</h1>
        <button class="btn btn-primary" id="btn-add-contact">+ Ajouter un contact</button>
    </div>


    <div class="modal fade" id="contactModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                
                <div class="modal-body" id="modal-content">
                    <!-- Form AJAX ici -->
                </div>
            </div>
        </div>
    </div>

    <!-- Filtres -->
    <div class="filter-section">
        <form method="GET" action="{{ path('app_contact_index') }}" class="filter-form">
            <div class="form-group">
                <label for="search_q" class="form-label">Rechercher</label>
                <input type="text" id="search_q" name="q" class="form-control" value="{{ searchQuery }}" placeholder="Nom, numéro, email...">
            </div>
            <div class="form-group">
                <label for="search_group" class="form-label">Par groupe</label>
                {{ form_widget(filterForm.group, {'attr': {'class': 'form-select', 'id': 'search_group'}}) }}
            </div>
            <div class="filter-actions">
                <button type="submit" class="btn btn-outline-secondary">
                    <i class="fas fa-search"></i> Appliquer
                </button>
                <a href="{{ path('app_contact_index') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-times"></i> Réinitialiser
                </a>
            </div>
        </form>
    </div>

    {% if contacts|length > 0 %}
        <!-- ✅ En dehors du tableau maintenant -->
        <div class="contacts-stats">
            {{ contacts|length }} contact(s) trouvé(s)
        </div>

        <div class="contacts-table-actions" style="text-align: right; margin-bottom: 1rem;">
            <button class="btn btn-outline-secondary btn-sm" onclick="exportContacts()">
                <i class="fas fa-download"></i> Exporter
            </button>
        </div>

        <div class="contacts-table-container">
            <table class="contacts-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Téléphone</th>
                        <th>Prénom</th>
                        <th>Nom</th>
                        <th>Email</th>
                        <th>Groupes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for contact in contacts %}
                        <tr>
                            <td>#{{ contact.id }}</td>
                            <td>{{ contact.phoneNumber }}</td>
                            <td>{{ contact.firstName }}</td>
                            <td>{{ contact.lastName }}</td>
                            <td>{{ contact.email ?: '—' }}</td>
                            <td>
                                {% for group in contact.contactGroups %}
                                    <span class="badge">{{ group.name }}</span>
                                {% else %}
                                    <span class="text-muted fst-italic">Aucun</span>
                                {% endfor %}
                            </td>
                            <td class="actions-cell">
                                <button class="btn btn-warning btn-sm btn-edit-contact" data-url="{{ path('app_contact_edit', {'id': contact.id}) }}" title="Modifier">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <form method="post" action="{{ path('app_contact_delete', {'id': contact.id}) }}" onsubmit="return confirm('Supprimer ce contact ?');" style="display: inline-block;">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ contact.id) }}">
                                    <button class="btn btn-danger btn-sm" title="Supprimer">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="empty-state">
            <i class="fas fa-address-book"></i>
            <div>Aucun contact trouvé</div>
            <div>
                {% if searchQuery or filterForm.group.vars.data %}
                    Ajustez vos filtres ou <a href="{{ path('app_contact_index') }}">réinitialisez</a>
                {% else %}
                    Commencez par ajouter un contact
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>

<script>
    function exportContacts() {
        window.location.href = "{{ path('app_contact_export') }}";
    }

    function bindAjaxForm() {
        const form = document.getElementById('contact-form');
        const modalElement = document.getElementById('contactModal');
        const modal = bootstrap.Modal.getInstance(document.getElementById('contactModal'));
        if (!form) return;

        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(form);
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => {
                if (response.status === 204) {
                    modal.hide();
                    location.reload();
                } else {
                    return response.text();
                }
            })
            .then(html => {
                if (html) {
                    document.getElementById('modal-content').innerHTML = html;
                    bindAjaxForm();
                }
            })
            .catch(err => {
                console.error("Erreur soumission :", err);
                alert("Erreur lors de la soumission du formulaire.");
            });
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        const modalContent = document.getElementById('modal-content');
        const modalElement = document.getElementById('contactModal');

        document.getElementById('btn-add-contact')?.addEventListener('click', function () {
            fetch("{{ path('app_contact_new') }}", {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(res => res.text())
            .then(html => {
                modalContent.innerHTML = html;
                bindAjaxForm();
                new bootstrap.Modal(modalElement).show();
            })
            .catch(err => {
                console.error("Erreur ouverture formulaire :", err);
                alert("Erreur ouverture formulaire.");
            });
        });

        document.querySelectorAll('.btn-edit-contact').forEach(button => {
            button.addEventListener('click', function () {
                const url = this.dataset.url;
                fetch(url, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(res => res.text())
                .then(html => {
                    modalContent.innerHTML = html;
                    bindAjaxForm();
                    new bootstrap.Modal(modalElement).show();
                })
                .catch(err => {
                    console.error("Erreur chargement formulaire :", err);
                    alert("Erreur chargement formulaire.");
                });
            });
        });
    });
</script>
{% endblock %}
